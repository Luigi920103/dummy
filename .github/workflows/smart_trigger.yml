name: Smart QA Trigger
on:
  push:
    branches: [ main ]

jobs:
  check-changes-and-dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Necesario para comparar el commit actual con el anterior

      - name: Detect Changes and Dispatch
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.ORCHESTRATOR_TOKEN }}
          repository: Luigi920103/qa-orchestrator
          event-type: trigger-automation
          # AquÃ­ usamos condicionales de shell para armar el JSON
          client_payload: >
            {
              "service": "${{ 
                contains(github.event.head_commit.modified, 'pw_ts_bdd/') && 'pw_ts_bdd' || 
                contains(github.event.head_commit.modified, 'pw_ts/') && 'pw_ts' ||
                contains(github.event.head_commit.modified, 'pw_js_bdd/') && 'pw_js_bdd' ||
                contains(github.event.head_commit.modified, 'pw_js/') && 'pw_js' ||
                'all' 
              }}",
              "env": "staging",
              "commit_sha": "${{ github.sha }}"
            }
